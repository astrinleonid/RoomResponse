# Room Response Recording Project

A Python-based acoustic room response measurement system using custom pulse-train signals for precise audio analysis. The system combines a C++ SDL audio core with Python signal processing and a Streamlit GUI for high-performance, cross-platform audio recording and analysis.

---

## 🎯 Overview

This project automates the collection of room acoustic response datasets for research, audio analysis, and ML applications. It measures how rooms respond to injected test signals (reverberation, echoes, frequency response) under different conditions.

**Highlights**

* Low-latency C++ audio engine with Python bindings (`sdl_audio_core`)
* Config-driven recorder (`RoomResponseRecorder`) and dataset collection
* Robust GUI with modular panels (Scenarios, Collect, Process, Classify, Predict, Visualize)
* Background **Series Worker** (stable timing, pause/resume/stop, watchdog)

---

## 🏗️ Architecture & Project Structure

```
RoomResponse/
├── sdl_audio_core/                  # C++ module with pybind11 bindings
│   ├── include/, src/               # audio_engine.*, device_manager.*, python_bindings.cpp
│   ├── setup.py                     # builds the Python extension
│   ├── build_config.json            # generated by tools/detect_paths.py
│   └── tools/
│       └── detect_paths.py          # detects SDL2 include/lib and writes build_config.json
├── RoomResponseRecorder.py          # High-level recorder (config-based)
├── DatasetCollector.py              # Single scenario collector (append/resume, QA, metadata)
├── collect_dataset.py               # CLI wrapper for single/series collection
├── FeatureExtractor.py              # MFCC & spectrum extraction (library)
├── ScenarioClassifier.py            # Train/eval, save/load, inference (library)
├── gui_launcher.py                  # Streamlit app entrypoint
├── ScenarioManager.py               # Central dataset/scenario management
├── gui_collect_panel.py             # Collect panel UI (single + series via worker)
├── gui_process_panel.py             # Process panel UI
├── gui_classify_panel.py            # Classify panel UI (planned/implemented per repo state)
├── gui_predict_panel.py             # Predict panel UI (planned)
├── gui_visualize_panel.py           # Visualize panel UI (planned)
├── gui_series_worker.py             # Series worker thread (beeps, pause/resume, watchdog)
├── scenario_explorer.py             # Scenario Explorer module (planned)
├── recorderConfig.json              # Signal + defaults config
├── room_response_dataset/           # Output dataset root (created on demand)
│   └── <computer>-Scenario<num>-<room>/
│       ├── raw_recordings/
│       ├── impulse_responses/
│       ├── room_responses/
│       ├── metadata/
│       ├── analysis/
│       └── <scenario>_SUMMARY.txt
└── scripts/
    ├── build_sdl_audio_core.bat     # **Windows helper to build/install the core**
    ├── batch_collect_scenarios.py   # Example batch run (cross-platform)
    └── batch_collect.ps1            # Example batch run (Windows)
```

---

## 🔧 Installation

### 1) Python Environment

* Python **3.8+** recommended.
* Create and activate a virtual environment, then:

```bash
pip install -U pip setuptools wheel
pip install numpy pybind11 streamlit pandas scipy scikit-learn matplotlib
```

### 2) SDL2 Prerequisites

* Install SDL2 **development** libraries.

  * **Windows:** download SDL2 dev ZIP from libsdl.org; extract.
  * **macOS:** `brew install sdl2`
  * **Linux (Debian/Ubuntu):** `sudo apt-get install libsdl2-dev`

> **Windows DLL note:** Copy `SDL2.dll` (or `SDL.dll` depending on your build/package) **into the working directory** (the folder where you run Python/Streamlit). Alternatively, ensure the folder containing the DLL is on your `PATH`. Missing DLLs are a common cause of runtime import/init failures.

### 3) Build and Install `sdl_audio_core`

You can build manually via `sdl_audio_core/setup.py`, or use the **Windows helper script** below for a one-step setup.

#### Windows: `scripts/build_sdl_audio_core.bat`

Create a file at `scripts/build_sdl_audio_core.bat` with the contents below and run it from the repo root via **Developer Command Prompt for VS** (or any shell with MSVC in PATH):

```bat
@echo off
setlocal ENABLEDELAYEDEXPANSION

:: --- Settings ---
set REPO_ROOT=%~dp0..\
set CORE_DIR=%REPO_ROOT%sdl_audio_core
set DLL_DEST=%REPO_ROOT%

:: 1) Ensure Python toolchain
python -m pip install -U pip setuptools wheel pybind11 || exit /b 1

:: 2) Detect or prompt for SDL2 paths (writes build_config.json)
if exist "%CORE_DIR%\tools\detect_paths.py" (
    python "%CORE_DIR%\tools\detect_paths.py" --auto || (
        echo.
        echo [!] Auto-detection failed. Edit sdl_audio_core\build_config.json manually and re-run.
        exit /b 1
    )
) else (
    echo [!] tools/detect_paths.py not found. Create sdl_audio_core\build_config.json manually.
)

:: 3) Build & install the extension
pushd "%CORE_DIR%"
python setup.py build_ext --inplace || exit /b 1
python -m pip install -e . || exit /b 1
popd

:: 4) Copy SDL2 runtime DLL next to your app (optional but recommended)
if exist "%SDL2_DIR%\lib\x64\SDL2.dll" copy /Y "%SDL2_DIR%\lib\x64\SDL2.dll" "%DLL_DEST%" >nul 2>&1
if exist "%SDL2_DIR%\bin\SDL2.dll" copy /Y "%SDL2_DIR%\bin\SDL2.dll" "%DLL_DEST%" >nul 2>&1
if exist "%ProgramFiles%\SDL2\bin\SDL2.dll" copy /Y "%ProgramFiles%\SDL2\bin\SDL2.dll" "%DLL_DEST%" >nul 2>&1

:: 5) Sanity check
python - <<PY
import sdl_audio_core as sdl
print("✅ sdl_audio_core:", sdl.get_version())
print("ℹ️ build:", sdl.get_build_info())
PY

echo.
echo Done. If import fails, verify SDL2.dll is present in the working directory or on PATH.
endlocal
```

#### macOS & Linux

```bash
# After installing SDL2 dev packages
cd sdl_audio_core
python -m pip install -e .  # builds and installs in editable mode
# Test
python - <<'PY'
import sdl_audio_core as sdl
print("✅ sdl_audio_core:", sdl.get_version())
print("ℹ️ build:", sdl.get_build_info())
PY
```

---

## ⚙️ Configuration (`recorderConfig.json`)

Minimal example:

```json
{
  "sample_rate": 48000,
  "pulse_duration": 0.008,
  "pulse_fade": 0.0001,
  "cycle_duration": 0.1,
  "num_pulses": 8,
  "volume": 0.4,
  "pulse_frequency": 1000,
  "impulse_form": "sine",
  "computer": "MyLaptop",
  "room": "LivingRoom"
}
```

---

## 🚀 How to Run

### GUI (Streamlit)

```bash
streamlit run gui_launcher.py
```

**Panels**

* **Scenarios**: dataset root, filtering, selection, inline explorer
* **Collect**: single (blocking) or series (background worker: pause/resume/stop, beeps, watchdog, interval modes)
* **Process**: feature extraction (MFCC & spectrum) via `FeatureExtractor.py`
* **Classify**: train/eval; save model artifacts to session
* **Predict**: single-sample inference (loads last trained model or uploaded)
* **Visualize**: confusion/accuracy matrices and feature importance

### CLI — Collection (Single & Series)

**Single** (interactive defaults):

```bash
python collect_dataset.py
```

**Single (quiet, explicit params):**

```bash
python collect_dataset.py \
  --config-file recorderConfig.json \
  --output-dir room_response_dataset \
  --quiet \
  --scenario-number 1 \
  --description "Empty room" \
  --num-measurements 50 \
  --measurement-interval 2.0
```

**Series** (ranges + tokens supported):

```bash
python collect_dataset.py \
  --series "0.1,0.2,1-3" \
  --pre-delay 60 --inter-delay 60 \
  --num-measurements 30 --measurement-interval 2.0 \
  --beep-volume 0.2 --beep-freq 880 --beep-dur 200
```

**Interactive device selection (single/series):** add `-i` or `--interactive`.

### CLI — Batch Scripts (Examples)

* **Cross‑platform Python:**

  ```bash
  python scripts/batch_collect_scenarios.py
  ```
* **Windows PowerShell:**

  ```powershell
  .\scripts\batch_collect.ps1
  ```

> These batch examples typically collect 5 scenarios (0.1–0.5) with 200 measurements each (\~100 minutes total).

### Additional Useful Commands

* **Check `sdl_audio_core` installation:**

  ```bash
  python - <<'PY'
  import sdl_audio_core as sdl
  print(sdl.get_build_info())
  PY
  ```
* **Quick device listing (from bindings):**

  ```python
  import sdl_audio_core as sdl
  print(sdl.list_all_devices())
  ```

---

## 📚 API Reference (Summary)

### `sdl_audio_core` (pybind11 bindings)

* `AudioEngine`, `AudioEngineConfig`, `AudioEngineStats`
* Device enumeration: `get_input_devices()`, `get_output_devices()`
* Start/stop engine, start/stop recording & playback, synchronized ops
* Helpers: `get_sdl_version()`, `get_audio_drivers()`, `list_all_devices()`, `get_build_info()`

### `RoomResponseRecorder`

**Constructor**: `RoomResponseRecorder(config_file_path: str | dict = None)`
**Key method**: `take_record(output_file, impulse_file, method=2, interactive=False, ...) -> np.ndarray | None`

### `DatasetCollector.SingleScenarioCollector`

* Append/overwrite/abort folder behavior; compatibility checks
* Metadata persisted to `metadata/session_metadata.json`
* Pause/Stop via sentinel files (`PAUSE`, `STOP`); resume support

### `collect_dataset.py`

* `_parse_series_expr(expr: str) -> List[str]`
* `_load_defaults_from_config(cfg_path: str) -> dict`
* `collect_scenarios_series(...)` public helper used by GUI worker

---

## 📊 Output Layout & Naming

**Scenario folder**: `<computer>-Scenario<number>-<room>`

* `raw_recordings/raw_<scenario>_IDX_TIMESTAMP.wav`
* `impulse_responses/impulse_<scenario>_IDX_TIMESTAMP.wav`
* `room_responses/room_<scenario>_IDX_TIMESTAMP.wav`
* `metadata/session_metadata.json` + `<scenario>_SUMMARY.txt`

---

## 🧪 Tips & Troubleshooting

* **DLLs on Windows**: ensure `SDL2.dll` (or `SDL.dll`) is next to your working script (`gui_launcher.py`, etc.) or on `PATH`.
* **Low SNR warnings**: reduce noise, adjust volume, improve mic/speaker placement.
* **Device issues**: try interactive selection (`-i`) or a different driver; verify devices via `sdl.list_all_devices()`.
* **Irregular intervals**: choose **End→Start** mode in GUI to guarantee cool‑down ≥ interval; warm‑up can be disabled or spaced.
* **Stuck recordings**: the worker uses a watchdog timeout; if it triggers repeatedly, recheck driver, buffer size, and SDL init.

---

## 🤝 Contributing

* Follow PEP8, add type hints and docstrings.
* Keep GUI panels thin; put logic in back-end modules (no duplication).
* Prefer dependency injection (pass `ScenarioManager`, etc.).

---

## 📄 License

Specify your license here.
