<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Spectrum Visualizer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .controls {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 200px;
        }

        label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
        }

        input[type="file"], select {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        input[type="file"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .info-panel {
            background: linear-gradient(45deg, #e8f5e8, #f0f8f0);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 5px solid #28a745;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }

        .plot-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .file-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #2196f3;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #f44336;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .control-group {
                flex-direction: column;
                align-items: stretch;
            }

            .control-item {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Audio Spectrum Visualizer</h1>

        <div class="controls">
            <div class="control-group">
                <div class="control-item">
                    <label for="spectrumFile">Select Spectrum CSV File:</label>
                    <input type="file" id="spectrumFile" accept=".csv" />
                </div>

                <div class="control-item">
                    <label for="sampleRate">Sample Rate (Hz):</label>
                    <select id="sampleRate">
                        <option value="16000" selected>16,000 Hz</option>
                        <option value="22050">22,050 Hz</option>
                        <option value="44100">44,100 Hz</option>
                        <option value="48000">48,000 Hz</option>
                    </select>
                </div>

                <div class="control-item">
                    <label for="plotType">Plot Type:</label>
                    <select id="plotType">
                        <option value="line" selected>Line Plot</option>
                        <option value="heatmap">Heatmap</option>
                        <option value="3d">3D Surface</option>
                        <option value="individual">Individual Spectra</option>
                    </select>
                </div>

                <div class="control-item">
                    <label for="freqRange">Frequency Range:</label>
                    <select id="freqRange">
                        <option value="full" selected>Full Range</option>
                        <option value="0-2000">0 - 2 kHz</option>
                        <option value="0-5000">0 - 5 kHz</option>
                        <option value="2000-8000">2 - 8 kHz</option>
                    </select>
                </div>
            </div>

            <div class="control-group">
                <button class="btn" onclick="loadAndVisualize()">Load & Visualize</button>
                <button class="btn" onclick="exportPlot()" id="exportBtn" disabled>Export Plot</button>
            </div>
        </div>

        <div id="fileInfo" class="file-info" style="display: none;"></div>
        <div id="error" class="error" style="display: none;"></div>

        <div id="statsPanel" class="info-panel" style="display: none;">
            <h3>üìä Dataset Statistics</h3>
            <div id="stats" class="stats"></div>
        </div>

        <div id="plotContainer" class="plot-container">
            <div id="loading" class="loading">
                Select a spectrum CSV file to begin visualization
            </div>
            <div id="plot" style="display: none;"></div>
        </div>
    </div>

    <script>
        let currentData = null;
        let frequencies = null;

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showFileInfo(filename, rows, cols) {
            const infoDiv = document.getElementById('fileInfo');
            infoDiv.innerHTML = `
                <strong>üìÅ File:</strong> ${filename}<br>
                <strong>üéµ Audio Files:</strong> ${rows}<br>
                <strong>üî¢ Frequency Bins:</strong> ${cols}
            `;
            infoDiv.style.display = 'block';
        }

        function calculateFrequencies(numBins, sampleRate) {
            const freq = [];
            for (let i = 0; i < numBins; i++) {
                freq.push((i * sampleRate) / (2 * (numBins - 1)));
            }
            return freq;
        }

        function getFrequencyRange(frequencies, range) {
            if (range === 'full') return [0, frequencies.length - 1];

            const [minFreq, maxFreq] = range.split('-').map(x => parseInt(x));
            let startIdx = 0, endIdx = frequencies.length - 1;

            for (let i = 0; i < frequencies.length; i++) {
                if (frequencies[i] >= minFreq && startIdx === 0) startIdx = i;
                if (frequencies[i] <= maxFreq) endIdx = i;
            }

            return [startIdx, endIdx];
        }

        function updateStatistics(data) {
            const statsPanel = document.getElementById('statsPanel');
            const statsDiv = document.getElementById('stats');

            // Calculate statistics
            const numFiles = data.length;
            const numFreqBins = data[0] ? data[0].length : 0;

            // Calculate average spectrum
            const avgSpectrum = new Array(numFreqBins).fill(0);
            const maxSpectrum = new Array(numFreqBins).fill(-Infinity);
            const minSpectrum = new Array(numFreqBins).fill(Infinity);

            for (let i = 0; i < data.length; i++) {
                for (let j = 0; j < numFreqBins; j++) {
                    const val = data[i][j];
                    avgSpectrum[j] += val;
                    maxSpectrum[j] = Math.max(maxSpectrum[j], val);
                    minSpectrum[j] = Math.min(minSpectrum[j], val);
                }
            }

            for (let j = 0; j < numFreqBins; j++) {
                avgSpectrum[j] /= numFiles;
            }

            const avgMagnitude = avgSpectrum.reduce((a, b) => a + b, 0) / numFreqBins;
            const peakFreq = frequencies[avgSpectrum.indexOf(Math.max(...avgSpectrum))];

            statsDiv.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${numFiles}</div>
                    <div class="stat-label">Audio Files</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${numFreqBins}</div>
                    <div class="stat-label">Frequency Bins</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${avgMagnitude.toFixed(3)}</div>
                    <div class="stat-label">Avg Magnitude</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${peakFreq.toFixed(0)} Hz</div>
                    <div class="stat-label">Peak Frequency</div>
                </div>
            `;

            statsPanel.style.display = 'block';
        }

        function createLinePlot(data, frequencies, freqRange) {
            const [startIdx, endIdx] = freqRange;
            const freqSlice = frequencies.slice(startIdx, endIdx + 1);

            const traces = [];

            if (data.length <= 10) {
                // Show individual lines for small datasets
                for (let i = 0; i < data.length; i++) {
                    traces.push({
                        x: freqSlice,
                        y: data[i].slice(startIdx, endIdx + 1),
                        type: 'scatter',
                        mode: 'lines',
                        name: `File ${i + 1}`,
                        opacity: 0.7
                    });
                }
            } else {
                // Show average and confidence intervals for large datasets
                const avgSpectrum = new Array(endIdx - startIdx + 1).fill(0);
                const stdSpectrum = new Array(endIdx - startIdx + 1).fill(0);

                // Calculate average
                for (let i = 0; i < data.length; i++) {
                    for (let j = startIdx; j <= endIdx; j++) {
                        avgSpectrum[j - startIdx] += data[i][j];
                    }
                }

                for (let j = 0; j < avgSpectrum.length; j++) {
                    avgSpectrum[j] /= data.length;
                }

                // Calculate standard deviation
                for (let i = 0; i < data.length; i++) {
                    for (let j = startIdx; j <= endIdx; j++) {
                        const diff = data[i][j] - avgSpectrum[j - startIdx];
                        stdSpectrum[j - startIdx] += diff * diff;
                    }
                }

                for (let j = 0; j < stdSpectrum.length; j++) {
                    stdSpectrum[j] = Math.sqrt(stdSpectrum[j] / data.length);
                }

                // Add confidence interval
                const upper = avgSpectrum.map((val, i) => val + stdSpectrum[i]);
                const lower = avgSpectrum.map((val, i) => val - stdSpectrum[i]);

                traces.push({
                    x: freqSlice.concat(freqSlice.slice().reverse()),
                    y: upper.concat(lower.slice().reverse()),
                    fill: 'toself',
                    fillcolor: 'rgba(102, 126, 234, 0.2)',
                    line: { color: 'transparent' },
                    name: '¬±1 Std Dev',
                    showlegend: true
                });

                traces.push({
                    x: freqSlice,
                    y: avgSpectrum,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Average Spectrum',
                    line: { color: '#667eea', width: 3 }
                });
            }

            return traces;
        }

        function createHeatmap(data, frequencies, freqRange) {
            const [startIdx, endIdx] = freqRange;
            const freqSlice = frequencies.slice(startIdx, endIdx + 1);
            const dataSlice = data.map(row => row.slice(startIdx, endIdx + 1));

            return [{
                z: dataSlice,
                x: freqSlice,
                y: data.map((_, i) => `File ${i + 1}`),
                type: 'heatmap',
                colorscale: 'Viridis',
                colorbar: {
                    title: 'Magnitude',
                    titleside: 'right'
                }
            }];
        }

        function create3DSurface(data, frequencies, freqRange) {
            const [startIdx, endIdx] = freqRange;
            const freqSlice = frequencies.slice(startIdx, endIdx + 1);
            const dataSlice = data.map(row => row.slice(startIdx, endIdx + 1));

            return [{
                z: dataSlice,
                x: freqSlice,
                y: data.map((_, i) => i + 1),
                type: 'surface',
                colorscale: 'Viridis',
                colorbar: {
                    title: 'Magnitude',
                    titleside: 'right'
                }
            }];
        }

        function createIndividualPlots(data, frequencies, freqRange) {
            const [startIdx, endIdx] = freqRange;
            const freqSlice = frequencies.slice(startIdx, endIdx + 1);

            // Create subplot layout
            const rows = Math.ceil(Math.sqrt(Math.min(data.length, 16)));
            const cols = Math.ceil(Math.min(data.length, 16) / rows);

            const traces = [];
            for (let i = 0; i < Math.min(data.length, 16); i++) {
                traces.push({
                    x: freqSlice,
                    y: data[i].slice(startIdx, endIdx + 1),
                    type: 'scatter',
                    mode: 'lines',
                    name: `File ${i + 1}`,
                    xaxis: `x${i + 1}`,
                    yaxis: `y${i + 1}`
                });
            }

            return traces;
        }

        function plotSpectrum() {
            if (!currentData || !frequencies) return;

            const plotType = document.getElementById('plotType').value;
            const freqRange = document.getElementById('freqRange').value;
            const freqIndices = getFrequencyRange(frequencies, freqRange);

            let traces, layout;

            switch (plotType) {
                case 'line':
                    traces = createLinePlot(currentData, frequencies, freqIndices);
                    layout = {
                        title: 'Audio Spectrum Analysis',
                        xaxis: { title: 'Frequency (Hz)' },
                        yaxis: { title: 'Magnitude' },
                        hovermode: 'x unified'
                    };
                    break;

                case 'heatmap':
                    traces = createHeatmap(currentData, frequencies, freqIndices);
                    layout = {
                        title: 'Spectrum Heatmap',
                        xaxis: { title: 'Frequency (Hz)' },
                        yaxis: { title: 'Audio Files' }
                    };
                    break;

                case '3d':
                    traces = create3DSurface(currentData, frequencies, freqIndices);
                    layout = {
                        title: '3D Spectrum Surface',
                        scene: {
                            xaxis: { title: 'Frequency (Hz)' },
                            yaxis: { title: 'File Index' },
                            zaxis: { title: 'Magnitude' }
                        }
                    };
                    break;

                case 'individual':
                    traces = createIndividualPlots(currentData, frequencies, freqIndices);
                    layout = {
                        title: 'Individual Spectra',
                        showlegend: false
                    };
                    break;
            }

            const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToAdd: ['pan2d', 'select2d', 'lasso2d', 'autoScale2d'],
                toImageButtonOptions: {
                    format: 'png',
                    filename: 'spectrum_plot',
                    height: 800,
                    width: 1200,
                    scale: 2
                }
            };

            Plotly.newPlot('plot', traces, layout, config);
            document.getElementById('plot').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('exportBtn').disabled = false;
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());

            // Find frequency columns (should start with 'freq_')
            const freqColumns = headers.filter(h => h.startsWith('freq_')).length;
            if (freqColumns === 0) {
                throw new Error('No frequency columns found (expected columns starting with "freq_")');
            }

            const data = [];
            const filenames = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length !== headers.length) continue;

                filenames.push(values[0]); // First column should be filename
                const spectrumData = [];

                for (let j = 1; j < values.length; j++) {
                    if (headers[j].startsWith('freq_')) {
                        spectrumData.push(parseFloat(values[j]) || 0);
                    }
                }

                data.push(spectrumData);
            }

            return { data, filenames, numFreqBins: freqColumns };
        }

        function loadAndVisualize() {
            const fileInput = document.getElementById('spectrumFile');
            const file = fileInput.files[0];

            if (!file) {
                showError('Please select a CSV file');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    document.getElementById('loading').style.display = 'block';
                    document.getElementById('plot').style.display = 'none';

                    const result = parseCSV(e.target.result);
                    currentData = result.data;

                    const sampleRate = parseInt(document.getElementById('sampleRate').value);
                    frequencies = calculateFrequencies(result.numFreqBins, sampleRate);

                    showFileInfo(file.name, result.data.length, result.numFreqBins);
                    updateStatistics(result.data);
                    plotSpectrum();

                } catch (error) {
                    showError(`Error parsing CSV: ${error.message}`);
                    document.getElementById('loading').style.display = 'block';
                    document.getElementById('plot').style.display = 'none';
                }
            };

            reader.readAsText(file);
        }

        function exportPlot() {
            if (document.getElementById('plot').style.display === 'none') {
                showError('No plot to export');
                return;
            }

            Plotly.downloadImage('plot', {
                format: 'png',
                filename: 'spectrum_analysis',
                height: 800,
                width: 1200,
                scale: 2
            });
        }

        // Event listeners
        document.getElementById('plotType').addEventListener('change', plotSpectrum);
        document.getElementById('freqRange').addEventListener('change', plotSpectrum);
        document.getElementById('sampleRate').addEventListener('change', function() {
            if (currentData) {
                const sampleRate = parseInt(this.value);
                frequencies = calculateFrequencies(currentData[0].length, sampleRate);
                updateStatistics(currentData);
                plotSpectrum();
            }
        });

        // Drag and drop functionality
        const container = document.querySelector('.container');

        container.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = '#667eea';
            this.style.backgroundColor = 'rgba(102, 126, 234, 0.05)';
        });

        container.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.borderColor = '';
            this.style.backgroundColor = '';
        });

        container.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = '';
            this.style.backgroundColor = '';

            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.csv')) {
                document.getElementById('spectrumFile').files = files;
                loadAndVisualize();
            }
        });
    </script>
</body>
</html>